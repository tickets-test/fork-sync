name: Sync forks with upstream

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # every hour

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Sync forks
        env:
          GH_TOKEN: ${{ secrets.ORG_SYNC_TOKEN }}
          ORG: tickets-test
        run: |
          set -e

          echo "Fetching forked repos in $ORG..."
          repos=$(gh api orgs/$ORG/repos --paginate --jq '.[] | select(.fork==true) | .name')

          for repo in $repos; do
            echo "Syncing $ORG/$repo..."

            # Get the default branch for this fork
            default_branch=$(gh api repos/$ORG/$repo --jq '.default_branch')

            # Use GitHub's built-in sync fork API
            if gh api repos/$ORG/$repo/merge-upstream -X POST -f branch="$default_branch" 2>/dev/null; then
              echo "✓ Synced $repo ($default_branch)"
            else
              echo "⚠ Could not sync $repo - may already be up to date or have conflicts"
            fi
          done

          echo "Done!"
